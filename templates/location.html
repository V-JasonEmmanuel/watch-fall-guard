{% extends "base.html" %}

{% block content %}
<div class="card location-card">
    <h2>Location & Geofencing</h2>
    <div id="map" class="map-container"></div>

    <div class="controls">
        <label>
            <input type="checkbox" id="geofence-toggle" onchange="toggleGeofence()"> Enable Geofence (500m)
        </label>
        <p id="status-msg">Status: Monitoring location...</p>
    </div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
    .location-card {
        height: 80vh;
        display: flex;
        flex-direction: column;
    }

    .map-container {
        flex-grow: 1;
        border-radius: var(--radius-md);
        margin-bottom: 1rem;
    }
</style>

<script>
    // Initialize Map
    // Default to New York for demo logic if GPS fails, but try HTML5 Geolocation
    const map = L.map('map').setView([40.7128, -74.0060], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    let marker;
    let circle;
    let geofenceEnabled = false;
    let homePos = null;

    // Get Real Location
    if (navigator.geolocation) {
        navigator.geolocation.watchPosition((position) => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const newLatLng = new L.LatLng(lat, lng);

            if (!marker) {
                marker = L.marker(newLatLng).addTo(map).bindPopup("Elder's Location").openPopup();
                map.setView(newLatLng, 15);
                homePos = newLatLng; // Set initial pos as "Home" for demo
            } else {
                marker.setLatLng(newLatLng);
            }

            checkGeofence(newLatLng);
            document.getElementById('status-msg').innerText = `Lat: ${lat.toFixed(4)}, Lng: ${lng.toFixed(4)}`;
        });
    } else {
        alert("Geolocation is not supported by this browser.");
    }

    function toggleGeofence() {
        geofenceEnabled = document.getElementById('geofence-toggle').checked;
        if (geofenceEnabled && homePos) {
            if (!circle) {
                circle = L.circle(homePos, {
                    color: 'red',
                    fillColor: '#f03',
                    fillOpacity: 0.2,
                    radius: 500
                }).addTo(map);
            }
        } else {
            if (circle) {
                map.removeLayer(circle);
                circle = null;
            }
        }
    }

    function checkGeofence(currentPos) {
        if (geofenceEnabled && homePos) {
            const distance = map.distance(currentPos, homePos);
            if (distance > 500) {
                alert("ALERT: Geofence Breached! Elder has moved outside the safe zone.");
                // Send API alert
            }
        }
    }
</script>
{% endblock %}